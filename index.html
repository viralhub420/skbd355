<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SKBD Reward App - Admin</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { background:#121212; color:white; text-align:center; font-family: Arial, sans-serif; padding:20px; }
.buttons { display:flex; flex-direction:column; gap:12px; margin-top:20px; }
button { padding:14px; background:#0088cc; color:white; border:none; border-radius:10px; font-size:16px; cursor: pointer; transition: 0.3s; }
button:disabled { opacity:0.5; background: #555; }
#info { background: #1e1e1e; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: bold; }
#adminPanel { display:none; background:#f39c12; margin-top:20px; padding:15px; border-radius:10px; }
.request-card { background:#2c3e50; padding:10px; margin-bottom:10px; border-radius:8px; text-align:left; font-size:14px; }
</style>
</head>

<body>
<h2>üöÄ SKBD Reward App</h2>
<div id="info">Loading...</div>

<div class="buttons">
  <button id="bonusBtn" onclick="claimDailyBonus()">üéÅ Daily Bonus</button>
  <button id="adBtn" onclick="watchAd()">üì∫ Watch Ad (+15 Coins)</button>
  <button id="linkBtn" onclick="clickLink()">üîó Click Link (+25 Coins)</button>
  
  <button id="adminBtn" style="display:none; background:#e67e22;" onclick="toggleAdminPanel()">üõ† Admin Panel</button>
  
  <button style="background:#e74c3c;" onclick="tg.close()">‚ùå Close App</button>
</div>

<div id="adminPanel">
  <h3>Pending Withdraws</h3>
  <div id="withdrawList">Loading requests...</div>
</div>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
firebase.initializeApp({
  apiKey: "AIzaSyD8ZSiPZ9HDJV1qGznPOBAu2qYN9lmSqWU",
  authDomain: "skbd355-reward-app.firebaseapp.com",
  projectId: "skbd355-reward-app"
});
const db = firebase.firestore();

/* ---------------- TELEGRAM INIT ---------------- */
const tg = window.Telegram.WebApp;
tg.expand();
const user = tg.initDataUnsafe?.user;
let userRef;
const ADMIN_ID = 6311806060; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø

/* ---------------- WITHDRAW BUTTON ---------------- */
tg.MainButton.text = "üí∞ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® (Withdraw)";
tg.MainButton.color = "#2ecc71";
tg.MainButton.show();

tg.MainButton.onClick(() => {
    if (!userRef) return;
    userRef.get().then(doc => {
        const balance = doc.data().balance || 0;
        if (balance < 1000) {
            tg.showAlert("‚ö†Ô∏è ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡ßß‡ß¶‡ß¶‡ß¶ ‡¶ï‡ßü‡ßá‡¶®‡ßá‡¶∞ ‡¶ï‡¶Æ!");
        } else {
            const phoneNumber = prompt("‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂/‡¶®‡¶ó‡¶¶ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®:");
            if (phoneNumber && phoneNumber.length >= 11) {
                db.collection("withdraws").add({
                    user_id: user.id,
                    name: user.first_name,
                    payment_number: phoneNumber,
                    amount: 1000,
                    status: "pending",
                    date: firebase.firestore.Timestamp.now()
                }).then(() => {
                    userRef.update({ balance: firebase.firestore.FieldValue.increment(-1000) });
                    tg.showAlert("‚úÖ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                });
            }
        }
    });
});

/* ---------------- USER SYNC & ADMIN CHECK ---------------- */
if (user) {
  userRef = db.collection("users").doc(String(user.id));
  
  // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
  if (user.id === ADMIN_ID) {
      document.getElementById("adminBtn").style.display = "block";
  }

  userRef.onSnapshot(doc => {
    if (doc.exists) {
      document.getElementById("info").innerText = `üë§ ID: ${doc.data().telegram_id} | üí∞ Coins: ${doc.data().balance}`;
    } else {
      userRef.set({ telegram_id: user.id, name: user.first_name, balance: 0 });
    }
  });
}

/* ---------------- ADMIN FUNCTIONS ---------------- */
function toggleAdminPanel() {
  const panel = document.getElementById("adminPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
  if (panel.style.display === "block") loadWithdrawRequests();
}

function loadWithdrawRequests() {
  db.collection("withdraws").where("status", "==", "pending").orderBy("date", "desc").get().then(querySnapshot => {
    let html = "";
    querySnapshot.forEach(doc => {
      const data = doc.data();
      html += `
        <div class="request-card">
          <b>Name:</b> ${data.name}<br>
          <b>Number:</b> ${data.payment_number}<br>
          <b>Amount:</b> ${data.amount}<br>
          <button style="padding:5px; font-size:12px; background:#27ae60; margin-top:5px;" onclick="markAsPaid('${doc.id}')">Mark Paid</button>
        </div>`;
    });
    document.getElementById("withdrawList").innerHTML = html || "No pending requests.";
  });
}

function markAsPaid(docId) {
  if (confirm("‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá?")) {
    db.collection("withdraws").doc(docId).update({ status: "success" }).then(() => {
      alert("Updated!");
      loadWithdrawRequests();
    });
  }
}

/* ---------------- FEATURES ---------------- */
const AD_LINK = "https://otieu.com/4/10540712";
function watchAd() { tg.openLink(AD_LINK); } // ‡¶°‡ßá‡¶Æ‡ßã ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function claimDailyBonus() { alert("‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü!"); }
function clickLink() { tg.openLink(AD_LINK); }
</script>
</body>
</html>
