<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SKBD Reward App</title>
<meta name="monetag" content="e0bef23b8097dd6c5178a64b918d79ec">
  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      background: #121212;
      color: white;
      text-align: center;
      font-family: Arial;
      padding: 30px;
    }
    .buttons {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    button {
      padding: 12px 20px;
      background: #0088cc;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <h2>ğŸš€ SKBD Reward App</h2>
  <p id="userid">Loading user...</p>

  <div class="buttons">
    <button onclick="claimDailyBonus()">ğŸ Daily Bonus</button>
    <button onclick="playGame()">ğŸ® Play Game</button>
    <button onclick="watchAd()">ğŸ“º Watch Ad</button>
    <button onclick="shortenLink()">ğŸ”— Click Link</button>
    <button onclick="offerWall()">ğŸ§² Offer Wall</button>
    <button onclick="Telegram.WebApp.close()">âŒ Close App</button>
  </div>

  <script>
    // ---------------- Firebase Config ----------------
    const firebaseConfig = {
  apiKey: "AIzaSyD8ZSiPZ9HDJV1qGznPOBAu2qYN9lmSqWU",
  authDomain: "skbd355-reward-app.firebaseapp.com",
  projectId: "skbd355-reward-app",
  storageBucket: "skbd355-reward-app.firebasestorage.app",
  messagingSenderId: "826200547927",
  appId: "1:826200547927:web:83e28d5187a3208716f912"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---------------- Telegram Init ----------------
    const tg = Telegram.WebApp;
    tg.expand();

    const user = tg.initDataUnsafe?.user;
    let userRef;

    if (user) {
      userRef = db.collection("users").doc(String(user.id));

      // Check if user exists
      userRef.get().then((doc) => {
        if (!doc.exists) {
          userRef.set({
            telegram_id: user.id,
            username: user.first_name || "",
            balance: 0,
            total_earned: 0,
            joined_at: firebase.firestore.FieldValue.serverTimestamp(),
            last_bonus: null
          });
          document.getElementById("userid").innerText =
            "ğŸ‘¤ User ID: " + user.id + " (New User)";
        } else {
          const data = doc.data();
          document.getElementById("userid").innerText =
            "ğŸ‘¤ User ID: " + data.telegram_id + " | Coins: " + data.balance;
        }
      });
    }

    // ---------------- Step A: Daily Bonus ----------------
    function claimDailyBonus() {
      if (!userRef) return;

      userRef.get().then((doc) => {
        if (!doc.exists) return;

        const data = doc.data();
        const lastBonus = data.last_bonus?.toDate();
        const now = new Date();
        const oneDay = 24 * 60 * 60 * 1000;

        if (!lastBonus || now - lastBonus >= oneDay) {
          const bonusAmount = 10;
          userRef.update({
            balance: firebase.firestore.FieldValue.increment(bonusAmount),
            total_earned: firebase.firestore.FieldValue.increment(bonusAmount),
            last_bonus: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            alert(`ğŸ‰ Daily Bonus: +${bonusAmount} Coins`);
            refreshUserUI();
          });
        } else {
          const nextClaim = new Date(lastBonus.getTime() + oneDay);
          alert(`â³ Next bonus available at: ${nextClaim.toLocaleString()}`);
        }
      });
    }

    // ---------------- Step A: Play Game ----------------
    function playGame() {
      if (!userRef) return;
      const reward = 20;
      userRef.update({
        balance: firebase.firestore.FieldValue.increment(reward),
        total_earned: firebase.firestore.FieldValue.increment(reward)
      }).then(() => {
        alert(`ğŸ® Game completed! +${reward} Coins`);
        refreshUserUI();
      });
    }

    // ---------------- Step B: Watch Ad ----------------
    function watchAd() {
      if (!userRef) return;
      const adReward = 15;
      userRef.update({
        balance: firebase.firestore.FieldValue.increment(adReward),
        total_earned: firebase.firestore.FieldValue.increment(adReward)
      }).then(() => {
        alert(`ğŸ“º Ad watched! +${adReward} Coins`);
        refreshUserUI();
      });
    }

    // ---------------- Step C: Click Link ----------------
    function shortenLink() {
      if (!userRef) return;
      const reward = 25;
      userRef.update({
        balance: firebase.firestore.FieldValue.increment(reward),
        total_earned: firebase.firestore.FieldValue.increment(reward)
      }).then(() => {
        alert(`ğŸ”— Link clicked! +${reward} Coins`);
        refreshUserUI();
      });
    }

    // ---------------- Step D: Offer Wall ----------------
    function offerWall() {
      if (!userRef) return;
      const reward = 50;
      userRef.update({
        balance: firebase.firestore.FieldValue.increment(reward),
        total_earned: firebase.firestore.FieldValue.increment(reward)
      }).then(() => {
        alert(`ğŸ§² Offer Completed! +${reward} Coins`);
        refreshUserUI();
      });
    }

    // ---------------- Refresh UI ----------------
    function refreshUserUI() {
      userRef.get().then(doc => {
        const data = doc.data();
        document.getElementById("userid").innerText =
          "ğŸ‘¤ User ID: " + data.telegram_id + " | Coins: " + data.balance;
      });
    }
  </script>
</body>
    </html>
