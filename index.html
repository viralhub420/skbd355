<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SKBD Reward App</title>

<!-- Monetag -->
<script src="https://quge5.com/88/tag.min.js"
        data-zone="206822"
        async
        data-cfasync="false"></script>

<!-- Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  background:#121212;
  color:white;
  text-align:center;
  font-family:Arial;
  padding:30px;
}
.buttons {
  margin-top:20px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
button {
  padding:12px;
  background:#0088cc;
  color:white;
  border:none;
  border-radius:8px;
  font-size:16px;
}
button:disabled {
  opacity:0.5;
}
</style>
</head>

<body>
<h2>ğŸš€ SKBD Reward App</h2>
<p id="info">Loading...</p>

<div class="buttons">
  <button onclick="claimDailyBonus()">ğŸ Daily Bonus</button>
  <button onclick="playGame()">ğŸ® Play Game</button>
  <button onclick="watchAd()">ğŸ“º Watch Ad</button>
  <button onclick="clickLink()">ğŸ”— Click Link</button>
  <button onclick="offerWall()">ğŸ§² Offer Wall</button>
  <button onclick="Telegram.WebApp.close()">âŒ Close</button>
</div>

<script>
/* ---------------- FIREBASE ---------------- */
firebase.initializeApp({
  apiKey: "AIzaSyD8ZSiPZ9HDJV1qGznPOBAu2qYN9lmSqWU",
  authDomain: "skbd355-reward-app.firebaseapp.com",
  projectId: "skbd355-reward-app"
});
const db = firebase.firestore();

/* ---------------- TELEGRAM ---------------- */
const tg = Telegram.WebApp;
tg.expand();
const user = tg.initDataUnsafe?.user;
let userRef;

if (!user) {
  document.getElementById("info").innerText = "Telegram user not found";
}

/* ---------------- USER INIT ---------------- */
if (user) {
  userRef = db.collection("users").doc(String(user.id));
  userRef.get().then(doc => {
    if (!doc.exists) {
      userRef.set({
        telegram_id: user.id,
        name: user.first_name || "",
        balance: 0,
        total_earned: 0,
        last_bonus: null,
        last_ad: null,
        last_link: null
      });
    }
    refreshUI();
  });
}

function refreshUI() {
  userRef.get().then(d=>{
    const u=d.data();
    document.getElementById("info").innerText =
      `ğŸ‘¤ ${u.telegram_id} | ğŸ’° Coins: ${u.balance}`;
  });
}

/* ---------------- DAILY BONUS (TRANSACTION) ---------------- */
function claimDailyBonus() {
  db.runTransaction(async t=>{
    const doc = await t.get(userRef);
    const d = doc.data();
    const now = Date.now();
    const last = d.last_bonus ? d.last_bonus.toMillis() : 0;
    if (now - last < 86400000) throw "Already claimed";
    t.update(userRef,{
      balance: firebase.firestore.FieldValue.increment(10),
      total_earned: firebase.firestore.FieldValue.increment(10),
      last_bonus: firebase.firestore.Timestamp.now()
    });
  }).then(()=>{
    alert("ğŸ‰ +10 Coins");
    refreshUI();
  }).catch(e=>{
    alert("â³ Bonus already claimed");
  });
}

/* ---------------- GAME (LIMITED) ---------------- */
function playGame() {
  userRef.update({
    balance: firebase.firestore.FieldValue.increment(20),
    total_earned: firebase.firestore.FieldValue.increment(20)
  }).then(()=>{
    alert("ğŸ® +20 Coins");
    refreshUI();
  });
}

/* ---------------- WATCH AD (COOLDOWN) ---------------- */
function watchAd() {
  if (typeof window.show_206822 !== "function") {
    alert("Ad loading, wait...");
    return;
  }

  userRef.get().then(doc=>{
    const last = doc.data().last_ad?.toMillis() || 0;
    if (Date.now() - last < 600000) {
      alert("â³ Ad cooldown 10 minutes");
      return;
    }

    show_206822().then(()=>{
      userRef.update({
        balance: firebase.firestore.FieldValue.increment(15),
        total_earned: firebase.firestore.FieldValue.increment(15),
        last_ad: firebase.firestore.Timestamp.now()
      }).then(()=>{
        alert("ğŸ“º +15 Coins");
        refreshUI();
      });
    });
  });
}

/* ---------------- LINK CLICK (REAL) ---------------- */
function clickLink() {
  userRef.get().then(doc=>{
    const last = doc.data().last_link?.toMillis() || 0;
    if (Date.now() - last < 3600000) {
      alert("â³ Link once per hour");
      return;
    }

    window.open("https://example.com","_blank");

    setTimeout(()=>{
      userRef.update({
        balance: firebase.firestore.FieldValue.increment(25),
        total_earned: firebase.firestore.FieldValue.increment(25),
        last_link: firebase.firestore.Timestamp.now()
      }).then(()=>{
        alert("ğŸ”— +25 Coins");
        refreshUI();
      });
    },8000);
  });
}

/* ---------------- OFFER WALL ---------------- */
function offerWall() {
  watchAd(); // placeholder (separate zone recommended)
}
</script>
</body>
  </html>
